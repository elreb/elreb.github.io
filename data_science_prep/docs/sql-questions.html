<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 SQL questions | Data Science Prep Guide</title>
  <meta name="description" content="Lab practices and data science best practices" />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 SQL questions | Data Science Prep Guide" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Lab practices and data science best practices" />
  <meta name="github-repo" content="elreb/data_science_prep" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 SQL questions | Data Science Prep Guide" />
  
  <meta name="twitter:description" content="Lab practices and data science best practices" />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="python-r-analyses.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Data Science Interview Guide</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome to the Data Science Prep Guide</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.0.1" data-path="introduction.html"><a href="introduction.html#sections"><i class="fa fa-check"></i><b>1.0.1</b> Sections</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="sql-questions.html"><a href="sql-questions.html"><i class="fa fa-check"></i><b>2</b> SQL questions</a>
<ul>
<li class="chapter" data-level="2.1" data-path="sql-questions.html"><a href="sql-questions.html#sql-tips"><i class="fa fa-check"></i><b>2.1</b> SQL tips</a></li>
<li class="chapter" data-level="2.2" data-path="sql-questions.html"><a href="sql-questions.html#sample-questions"><i class="fa fa-check"></i><b>2.2</b> Sample Questions</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="sql-questions.html"><a href="sql-questions.html#calculate-the-30-day-readmission-rate"><i class="fa fa-check"></i><b>2.2.1</b> Calculate the 30 day readmission rate</a></li>
<li class="chapter" data-level="2.2.2" data-path="sql-questions.html"><a href="sql-questions.html#top-10-diagnoses-from-encounters-with-a-length-of-service-greater-then-3-days"><i class="fa fa-check"></i><b>2.2.2</b> Top 10 diagnoses from encounters with a length of service greater then 3 days</a></li>
<li class="chapter" data-level="2.2.3" data-path="sql-questions.html"><a href="sql-questions.html#employee-survey-results"><i class="fa fa-check"></i><b>2.2.3</b> Employee survey results</a></li>
<li class="chapter" data-level="2.2.4" data-path="sql-questions.html"><a href="sql-questions.html#calculating-student-attendance"><i class="fa fa-check"></i><b>2.2.4</b> Calculating student attendance</a></li>
<li class="chapter" data-level="2.2.5" data-path="sql-questions.html"><a href="sql-questions.html#music-streaming-behavior"><i class="fa fa-check"></i><b>2.2.5</b> Music streaming behavior</a></li>
<li class="chapter" data-level="2.2.6" data-path="sql-questions.html"><a href="sql-questions.html#a-hotel-chains-loyal-customers"><i class="fa fa-check"></i><b>2.2.6</b> A hotel chain’s loyal customers</a></li>
<li class="chapter" data-level="2.2.7" data-path="sql-questions.html"><a href="sql-questions.html#user-churn-on-instagram"><i class="fa fa-check"></i><b>2.2.7</b> User churn on Instagram</a></li>
<li class="chapter" data-level="2.2.8" data-path="sql-questions.html"><a href="sql-questions.html#group-users-by-year-month-and-count-visits"><i class="fa fa-check"></i><b>2.2.8</b> Group users by year-month and count visits</a></li>
<li class="chapter" data-level="2.2.9" data-path="sql-questions.html"><a href="sql-questions.html#weekly-retention-report-with-log-data"><i class="fa fa-check"></i><b>2.2.9</b> Weekly retention report with log data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="python-r-analyses.html"><a href="python-r-analyses.html"><i class="fa fa-check"></i><b>3</b> Python / R analyses</a>
<ul>
<li class="chapter" data-level="3.1" data-path="python-r-analyses.html"><a href="python-r-analyses.html#sample-questions-1"><i class="fa fa-check"></i><b>3.1</b> Sample Questions</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="python-r-analyses.html"><a href="python-r-analyses.html#active-users-on-a-messaging-application"><i class="fa fa-check"></i><b>3.1.1</b> Active users on a messaging application</a></li>
<li class="chapter" data-level="3.1.2" data-path="python-r-analyses.html"><a href="python-r-analyses.html#time-for-a-response-on-a-messaging-application"><i class="fa fa-check"></i><b>3.1.2</b> Time for a response on a messaging application</a></li>
<li class="chapter" data-level="3.1.3" data-path="python-r-analyses.html"><a href="python-r-analyses.html#cleaning-and-analyzing-employee-data"><i class="fa fa-check"></i><b>3.1.3</b> Cleaning and analyzing employee data</a></li>
<li class="chapter" data-level="3.1.4" data-path="python-r-analyses.html"><a href="python-r-analyses.html#analyzing-employee-data"><i class="fa fa-check"></i><b>3.1.4</b> Analyzing employee data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html"><i class="fa fa-check"></i><b>4</b> Statistics and Machine Learning</a>
<ul>
<li class="chapter" data-level="4.1" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#overview-of-important-statistical-concepts"><i class="fa fa-check"></i><b>4.1</b> Overview of Important Statistical Concepts</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#probability-and-sampling-distributions"><i class="fa fa-check"></i><b>4.1.1</b> Probability and Sampling Distributions</a></li>
<li class="chapter" data-level="4.1.2" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#exploratory-data-analysis"><i class="fa fa-check"></i><b>4.1.2</b> Exploratory Data Analysis</a></li>
<li class="chapter" data-level="4.1.3" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#statistical-experiments-and-significance-testing"><i class="fa fa-check"></i><b>4.1.3</b> Statistical Experiments and Significance Testing</a></li>
<li class="chapter" data-level="4.1.4" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#regression-and-classification"><i class="fa fa-check"></i><b>4.1.4</b> Regression and Classification</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#sample-questions-2"><i class="fa fa-check"></i><b>4.2</b> Sample Questions</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#comparison-of-means"><i class="fa fa-check"></i><b>4.2.1</b> Comparison of means</a></li>
<li class="chapter" data-level="4.2.2" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#principle-of-inclusionexclusion"><i class="fa fa-check"></i><b>4.2.2</b> Principle of Inclusion/Exclusion</a></li>
<li class="chapter" data-level="4.2.3" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#bayes-theorem-1"><i class="fa fa-check"></i><b>4.2.3</b> Bayes Theorem 1</a></li>
<li class="chapter" data-level="4.2.4" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#mae-vs-mse"><i class="fa fa-check"></i><b>4.2.4</b> MAE vs MSE</a></li>
<li class="chapter" data-level="4.2.5" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#bias-variance-tradeoff-1"><i class="fa fa-check"></i><b>4.2.5</b> Bias variance tradeoff</a></li>
<li class="chapter" data-level="4.2.6" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#changing-the-companys-color"><i class="fa fa-check"></i><b>4.2.6</b> Changing the company’s color</a></li>
<li class="chapter" data-level="4.2.7" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#repeated-significance-testing-error"><i class="fa fa-check"></i><b>4.2.7</b> Repeated significance testing error</a></li>
<li class="chapter" data-level="4.2.8" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#bias-variance-tradeoff-2"><i class="fa fa-check"></i><b>4.2.8</b> Bias Variance Tradeoff</a></li>
<li class="chapter" data-level="4.2.9" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#drawing-cards-from-a-standard-deck"><i class="fa fa-check"></i><b>4.2.9</b> Drawing cards from a standard deck</a></li>
<li class="chapter" data-level="4.2.10" data-path="statistics-and-machine-learning.html"><a href="statistics-and-machine-learning.html#assocation-vs-causation"><i class="fa fa-check"></i><b>4.2.10</b> Assocation vs causation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="case-studies.html"><a href="case-studies.html"><i class="fa fa-check"></i><b>5</b> Case Studies</a>
<ul>
<li class="chapter" data-level="5.1" data-path="case-studies.html"><a href="case-studies.html#case-study-tips"><i class="fa fa-check"></i><b>5.1</b> Case Study Tips</a></li>
<li class="chapter" data-level="5.2" data-path="case-studies.html"><a href="case-studies.html#sample-questions-3"><i class="fa fa-check"></i><b>5.2</b> Sample Questions</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="case-studies.html"><a href="case-studies.html#ab-testing-basics-1"><i class="fa fa-check"></i><b>5.2.1</b> AB Testing Basics 1</a></li>
<li class="chapter" data-level="5.2.2" data-path="case-studies.html"><a href="case-studies.html#ab-testing-new-ecommerce-recommendation-engine"><i class="fa fa-check"></i><b>5.2.2</b> A/B testing new eCommerce recommendation engine</a></li>
<li class="chapter" data-level="5.2.3" data-path="case-studies.html"><a href="case-studies.html#ab-testing-a-new-landing-page"><i class="fa fa-check"></i><b>5.2.3</b> A/B testing a new landing page</a></li>
<li class="chapter" data-level="5.2.4" data-path="case-studies.html"><a href="case-studies.html#stopping-an-ab-test-early"><i class="fa fa-check"></i><b>5.2.4</b> Stopping an AB Test early</a></li>
<li class="chapter" data-level="5.2.5" data-path="case-studies.html"><a href="case-studies.html#cohort-analysis"><i class="fa fa-check"></i><b>5.2.5</b> Cohort analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="computer-science-data-scructures-and-algorithms.html"><a href="computer-science-data-scructures-and-algorithms.html"><i class="fa fa-check"></i><b>6</b> Computer Science / Data Scructures and Algorithms</a>
<ul>
<li class="chapter" data-level="6.1" data-path="computer-science-data-scructures-and-algorithms.html"><a href="computer-science-data-scructures-and-algorithms.html#sample-questions-4"><i class="fa fa-check"></i><b>6.1</b> Sample Questions</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="computer-science-data-scructures-and-algorithms.html"><a href="computer-science-data-scructures-and-algorithms.html#calulate-moving-average-using-python"><i class="fa fa-check"></i><b>6.1.1</b> Calulate moving average using Python</a></li>
<li class="chapter" data-level="6.1.2" data-path="computer-science-data-scructures-and-algorithms.html"><a href="computer-science-data-scructures-and-algorithms.html#python-function-to-express-power-sets"><i class="fa fa-check"></i><b>6.1.2</b> Python function to express power sets</a></li>
<li class="chapter" data-level="6.1.3" data-path="computer-science-data-scructures-and-algorithms.html"><a href="computer-science-data-scructures-and-algorithms.html#if-you-were-given-a-m-by-n-matrix-how-would-you-find-the-minimum-element-using-brute-force-algorithm"><i class="fa fa-check"></i><b>6.1.3</b> If you were given a m by n matrix how would you find the minimum element using brute force algorithm</a></li>
<li class="chapter" data-level="6.1.4" data-path="computer-science-data-scructures-and-algorithms.html"><a href="computer-science-data-scructures-and-algorithms.html#finding-the-value-closest-to-0"><i class="fa fa-check"></i><b>6.1.4</b> Finding the value closest to 0</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/elreb/data_science_prep" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data Science Prep Guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sql-questions" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">Chapter 2</span> SQL questions<a href="sql-questions.html#sql-questions" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><em>Note the solutions provided here are based off of PostgreSQL syntax of SQL.</em></p>
<div id="sql-tips" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> SQL tips<a href="sql-questions.html#sql-tips" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Some keywords are especially useful for SQL interview problems. Here are some that I suggest to know how to use well:</p>
<ol style="list-style-type: decimal">
<li><code>INNER JOIN</code>, <code>LEFT JOIN</code>, <code>FULL JOIN</code> - just know them!</li>
<li><code>COALESCE</code></li>
</ol>
<ul>
<li>textbook definition - function returns the first non-NULL expression in the specified list. If all the arguments are NULL then it will return NULL as its output.</li>
<li>use to replace certain values to a default value (but in interviews mostly use for NULL or outliers).</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><code>CASE WHEN</code> - expression is the same as IF/ELSE statement in other programming languages.</li>
</ol>
<ul>
<li>e.g. </li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="sql-questions.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> title,</span>
<span id="cb1-2"><a href="sql-questions.html#cb1-2" aria-hidden="true" tabindex="-1"></a>       rating,</span>
<span id="cb1-3"><a href="sql-questions.html#cb1-3" aria-hidden="true" tabindex="-1"></a>       <span class="cf">CASE</span> rating</span>
<span id="cb1-4"><a href="sql-questions.html#cb1-4" aria-hidden="true" tabindex="-1"></a>           <span class="cf">WHEN</span> <span class="st">&#39;G&#39;</span> <span class="cf">THEN</span> <span class="st">&#39;General Audiences&#39;</span></span>
<span id="cb1-5"><a href="sql-questions.html#cb1-5" aria-hidden="true" tabindex="-1"></a>           <span class="cf">WHEN</span> <span class="st">&#39;PG&#39;</span> <span class="cf">THEN</span> <span class="st">&#39;Parental Guidance Suggested&#39;</span></span>
<span id="cb1-6"><a href="sql-questions.html#cb1-6" aria-hidden="true" tabindex="-1"></a>           <span class="cf">WHEN</span> <span class="st">&#39;PG-13&#39;</span> <span class="cf">THEN</span> <span class="st">&#39;Parents Strongly Cautioned&#39;</span></span>
<span id="cb1-7"><a href="sql-questions.html#cb1-7" aria-hidden="true" tabindex="-1"></a>           <span class="cf">WHEN</span> <span class="st">&#39;R&#39;</span> <span class="cf">THEN</span> <span class="st">&#39;Restricted&#39;</span></span>
<span id="cb1-8"><a href="sql-questions.html#cb1-8" aria-hidden="true" tabindex="-1"></a>           <span class="cf">WHEN</span> <span class="st">&#39;NC-17&#39;</span> <span class="cf">THEN</span> <span class="st">&#39;Adults Only&#39;</span></span>
<span id="cb1-9"><a href="sql-questions.html#cb1-9" aria-hidden="true" tabindex="-1"></a>       <span class="cf">END</span> rating_description</span>
<span id="cb1-10"><a href="sql-questions.html#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> film</span>
<span id="cb1-11"><a href="sql-questions.html#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> title;</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li><code>SUM CASE WHEN</code> - can use to aggregate a count of a certain row category.</li>
</ol>
<ul>
<li>e.g.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="sql-questions.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb2-2"><a href="sql-questions.html#cb2-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">SUM</span>(<span class="cf">CASE</span> rating</span>
<span id="cb2-3"><a href="sql-questions.html#cb2-3" aria-hidden="true" tabindex="-1"></a>           <span class="cf">WHEN</span> <span class="st">&#39;G&#39;</span> <span class="cf">THEN</span> <span class="dv">1</span> </span>
<span id="cb2-4"><a href="sql-questions.html#cb2-4" aria-hidden="true" tabindex="-1"></a>           <span class="cf">ELSE</span> <span class="dv">0</span> </span>
<span id="cb2-5"><a href="sql-questions.html#cb2-5" aria-hidden="true" tabindex="-1"></a>         <span class="cf">END</span>) <span class="ot">&quot;General Audiences&quot;</span></span>
<span id="cb2-6"><a href="sql-questions.html#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> film</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li><p><code>ROUND</code> - when using floats or making percentages just use it for more readable output.</p></li>
<li><p>Common Table Expressions (CTEs), and subqueries - know how to use them, you’ll need them!</p></li>
<li><p><code>HAVING</code> vs <code>WHERE</code> - The difference between the having and where clause in SQL is that the where clause cannot be used with aggregates, but the having clause can. The where clause works on row’s data, not on aggregated data.</p></li>
<li><p>Casting data types with <code>CAST</code> or <code>::</code></p></li>
<li><p>Misc window functions - which perform an operation across a set of rows that are somehow related to the current row.</p>
<p><em>Fetching - Relative</em></p></li>
</ol>
<ul>
<li><code>LAG(column, n)</code> returns column’s value at the row n rows before the current row</li>
<li><code>LEAD(column, n)</code> returns column’s value at the row n rows after the current row</li>
</ul>
<p><img src="assets/images/sql_lead_ex.png" width="65%" style="display: block; margin: auto;" /></p>
<p><img src="assets/images/sql_lead_w_partition.png" width="65%" style="display: block; margin: auto;" />
<em>Fetching - Absolute</em></p>
<ul>
<li><code>FIRST_VALUE(column)</code> returns the first value in the table or partition</li>
<li><code>LAST_VALUE(column)</code> returns the last value in the table or partition</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-5"></span>
<img src="assets/images/sql_first_last_value_ex.png" alt="RANGE BETWEEN clause extends the window to the end of the table or partition." width="65%" />
<p class="caption">
Figure 2.1: RANGE BETWEEN clause extends the window to the end of the table or partition.
</p>
</div>
<p><img src="assets/images/sql_firstvalue_w_partition.png" width="65%" style="display: block; margin: auto;" /></p>
<ul>
<li><p><code>ROW_NUMBER()</code> always assigns unique numbers, even if two rows’ values are the same
<img src="assets/images/sql_rownumber_ex.png" width="65%" style="display: block; margin: auto;" /></p></li>
<li><p><code>RANK()</code> assigns the same number to rows with identical values, skipping over the next numbers in such cases</p></li>
<li><p><code>DENSE_RANK()</code> also assigns the same number to rows with identical values, but doesn’t skip over the next numbers</p></li>
<li><p>Frames</p>
<ul>
<li>ROWS BETWEEN [START] AND [FINISH]</li>
<li>n PRECEDING: n rows before the current row</li>
<li>CURRENT ROW: the current row</li>
<li>n FOLLOWING: n rows after the current row</li>
</ul></li>
</ul>
<p><img src="assets/images/sql_movingavg_ex.png" width="65%" style="display: block; margin: auto;" /></p>
<p>Also, use tools to make mock datasets to <em>CHECK</em> your work. Try to first solve as an interview would, with no interactivity. Pay attention to things missed between when you solved it and checked your work.</p>
<ol style="list-style-type: decimal">
<li><a href="https://tableconvert.com/excel-to-sql">Convert excel table to help generate SQL insert statements</a></li>
<li>SQL sandboxes:<a href="https://www.db-fiddle.com/">db-fiddle.com</a>, and <a href="http://sqlfiddle.com">sqlfiddle.com</a></li>
</ol>
</div>
<div id="sample-questions" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> Sample Questions<a href="sql-questions.html#sample-questions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="calculate-the-30-day-readmission-rate" class="section level3 hasAnchor" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Calculate the 30 day readmission rate<a href="sql-questions.html#calculate-the-30-day-readmission-rate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Table:</strong> <code>encounter</code>
<strong>Columns:</strong> <code>patient_id, encounter_id, encounter_start, encounter_end, encounter_class (in patient)</code></p>
<p><a href="http://sqlfiddle.com/#!15/1b90a/19">sql fiddle</a></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="sql-questions.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> encounter</span>
<span id="cb3-2"><a href="sql-questions.html#cb3-2" aria-hidden="true" tabindex="-1"></a>    (patient_id <span class="dt">int</span>, admid <span class="dt">int</span>, adm_date <span class="dt">date</span>, dis_date <span class="dt">date</span>, encounter_class <span class="dt">int</span>)</span>
<span id="cb3-3"><a href="sql-questions.html#cb3-3" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb3-4"><a href="sql-questions.html#cb3-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-5"><a href="sql-questions.html#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> encounter</span>
<span id="cb3-6"><a href="sql-questions.html#cb3-6" aria-hidden="true" tabindex="-1"></a>    (patient_id, admid, adm_date, dis_date, encounter_class)</span>
<span id="cb3-7"><a href="sql-questions.html#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb3-8"><a href="sql-questions.html#cb3-8" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0001</span>, <span class="dv">10000</span>, <span class="st">&#39;2017-01-01 04:05:06&#39;</span>, <span class="st">&#39;2017-01-05 04:05:06&#39;</span>, <span class="dv">5</span>),</span>
<span id="cb3-9"><a href="sql-questions.html#cb3-9" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0002</span>, <span class="dv">10001</span>, <span class="st">&#39;2017-02-01 04:05:06&#39;</span>, <span class="st">&#39;2017-02-02 04:05:06&#39;</span>, <span class="dv">3</span>),</span>
<span id="cb3-10"><a href="sql-questions.html#cb3-10" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0003</span>, <span class="dv">10002</span>, <span class="st">&#39;2017-03-01 04:05:06&#39;</span>, <span class="st">&#39;2017-03-04 04:05:06&#39;</span>, <span class="dv">2</span>),</span>
<span id="cb3-11"><a href="sql-questions.html#cb3-11" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0004</span>, <span class="dv">10003</span>, <span class="st">&#39;2017-04-01 04:05:06&#39;</span>, <span class="st">&#39;2017-04-15 04:05:06&#39;</span>, <span class="dv">4</span>),</span>
<span id="cb3-12"><a href="sql-questions.html#cb3-12" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0001</span>, <span class="dv">10004</span>, <span class="st">&#39;2017-05-01 04:05:06&#39;</span>, <span class="st">&#39;2017-05-02 04:05:06&#39;</span>, <span class="dv">2</span>),</span>
<span id="cb3-13"><a href="sql-questions.html#cb3-13" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0005</span>, <span class="dv">10005</span>, <span class="st">&#39;2017-06-01 04:05:06&#39;</span>, <span class="st">&#39;2017-06-05 04:05:06&#39;</span>, <span class="dv">1</span>),</span>
<span id="cb3-14"><a href="sql-questions.html#cb3-14" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0001</span>, <span class="dv">10006</span>, <span class="st">&#39;2017-04-01 04:05:06&#39;</span>, <span class="st">&#39;2017-04-03 04:05:06&#39;</span>, <span class="dv">1</span>),</span>
<span id="cb3-15"><a href="sql-questions.html#cb3-15" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0002</span>, <span class="dv">10007</span>, <span class="st">&#39;2017-03-01 04:05:06&#39;</span>, <span class="st">&#39;2017-03-15 04:05:06&#39;</span>, <span class="dv">7</span>),</span>
<span id="cb3-16"><a href="sql-questions.html#cb3-16" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0006</span>, <span class="dv">10008</span>, <span class="st">&#39;2017-02-01 04:05:06&#39;</span>, <span class="st">&#39;2017-02-05 04:05:06&#39;</span>, <span class="dv">2</span>),</span>
<span id="cb3-17"><a href="sql-questions.html#cb3-17" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0003</span>, <span class="dv">10009</span>, <span class="st">&#39;2017-07-01 04:05:06&#39;</span>, <span class="st">&#39;2017-07-03 04:05:06&#39;</span>, <span class="dv">1</span>),</span>
<span id="cb3-18"><a href="sql-questions.html#cb3-18" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0007</span>, <span class="dv">10010</span>, <span class="st">&#39;2017-09-01 04:05:06&#39;</span>, <span class="st">&#39;2017-09-20 04:05:06&#39;</span>, <span class="dv">2</span>)</span>
<span id="cb3-19"><a href="sql-questions.html#cb3-19" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb3-20"><a href="sql-questions.html#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="sql-questions.html#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">/* make indicator for patient id, if readmitted within 30 days</span></span>
<span id="cb3-22"><a href="sql-questions.html#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"> merge cte for total count of unique admissions*/</span></span>
<span id="cb3-23"><a href="sql-questions.html#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="sql-questions.html#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> next_date_tbl <span class="kw">AS</span> (</span>
<span id="cb3-25"><a href="sql-questions.html#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> </span>
<span id="cb3-26"><a href="sql-questions.html#cb3-26" aria-hidden="true" tabindex="-1"></a>    patient_id,</span>
<span id="cb3-27"><a href="sql-questions.html#cb3-27" aria-hidden="true" tabindex="-1"></a>    adm_date,</span>
<span id="cb3-28"><a href="sql-questions.html#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">LEAD</span>(adm_date, <span class="dv">1</span>) <span class="kw">OVER</span> (</span>
<span id="cb3-29"><a href="sql-questions.html#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">PARTITION</span> <span class="kw">BY</span> patient_id</span>
<span id="cb3-30"><a href="sql-questions.html#cb3-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ORDER</span> <span class="kw">BY</span> adm_date</span>
<span id="cb3-31"><a href="sql-questions.html#cb3-31" aria-hidden="true" tabindex="-1"></a>    ) <span class="kw">AS</span> next_date</span>
<span id="cb3-32"><a href="sql-questions.html#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> encounter</span>
<span id="cb3-33"><a href="sql-questions.html#cb3-33" aria-hidden="true" tabindex="-1"></a>), date_dif_tbl <span class="kw">AS</span> (</span>
<span id="cb3-34"><a href="sql-questions.html#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> </span>
<span id="cb3-35"><a href="sql-questions.html#cb3-35" aria-hidden="true" tabindex="-1"></a>    patient_id,</span>
<span id="cb3-36"><a href="sql-questions.html#cb3-36" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">CAST</span>(next_date <span class="kw">AS</span> <span class="dt">DATE</span>) <span class="op">-</span> <span class="fu">CAST</span>(adm_date <span class="kw">AS</span> <span class="dt">DATE</span>)) <span class="kw">AS</span> date_dif</span>
<span id="cb3-37"><a href="sql-questions.html#cb3-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> next_date_tbl </span>
<span id="cb3-38"><a href="sql-questions.html#cb3-38" aria-hidden="true" tabindex="-1"></a>), num_denom <span class="kw">AS</span> (</span>
<span id="cb3-39"><a href="sql-questions.html#cb3-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> </span>
<span id="cb3-40"><a href="sql-questions.html#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> </span>
<span id="cb3-41"><a href="sql-questions.html#cb3-41" aria-hidden="true" tabindex="-1"></a>          date_dif <span class="op">&lt;=</span> <span class="dv">30</span> <span class="cf">THEN</span> <span class="dv">1</span></span>
<span id="cb3-42"><a href="sql-questions.html#cb3-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> readmitted,</span>
<span id="cb3-43"><a href="sql-questions.html#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total_cnt</span>
<span id="cb3-44"><a href="sql-questions.html#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> date_dif_tbl</span>
<span id="cb3-45"><a href="sql-questions.html#cb3-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-46"><a href="sql-questions.html#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> (<span class="fu">ROUND</span>((readmitted:<span class="ch">:float</span><span class="op">/</span>total_cnt:<span class="ch">:float</span>):<span class="ch">:numeric</span>,<span class="dv">2</span>) <span class="op">*</span> <span class="dv">100</span>) <span class="kw">AS</span> thirty_day_readmission_rt</span>
<span id="cb3-47"><a href="sql-questions.html#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> num_denom</span></code></pre></div>
</div>
<div id="top-10-diagnoses-from-encounters-with-a-length-of-service-greater-then-3-days" class="section level3 hasAnchor" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Top 10 diagnoses from encounters with a length of service greater then 3 days<a href="sql-questions.html#top-10-diagnoses-from-encounters-with-a-length-of-service-greater-then-3-days" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li>SQL</li>
<li>Database Querying</li>
<li>Health records</li>
</ul>
<p><strong>Table:</strong> <code>encounter</code>
<strong>Columns:</strong> <code>encounter_id, diagnosis_id, priority, encounter_start, encounter_end</code></p>
<p><a href="http://sqlfiddle.com/#!15/02c6d/1">sql fiddle</a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="sql-questions.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> encounters</span>
<span id="cb4-2"><a href="sql-questions.html#cb4-2" aria-hidden="true" tabindex="-1"></a>  (encounter_id <span class="dt">int</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>, diagnosis_id <span class="dt">int</span>, encounter_start <span class="dt">TIMESTAMP</span>, encounter_end <span class="dt">TIMESTAMP</span>);</span>
<span id="cb4-3"><a href="sql-questions.html#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="sql-questions.html#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> encounters</span>
<span id="cb4-5"><a href="sql-questions.html#cb4-5" aria-hidden="true" tabindex="-1"></a>  (encounter_id, diagnosis_id, encounter_start, encounter_end)</span>
<span id="cb4-6"><a href="sql-questions.html#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb4-7"><a href="sql-questions.html#cb4-7" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="dv">5</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;2022-01-20 04:05:06&#39;</span>),</span>
<span id="cb4-8"><a href="sql-questions.html#cb4-8" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="dv">5</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;2022-01-20 04:05:06&#39;</span>),</span>
<span id="cb4-9"><a href="sql-questions.html#cb4-9" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="dv">5</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;2022-01-20 04:05:06&#39;</span>),</span>
<span id="cb4-10"><a href="sql-questions.html#cb4-10" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">4</span>, <span class="dv">2</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;2022-01-20 04:05:06&#39;</span>),</span>
<span id="cb4-11"><a href="sql-questions.html#cb4-11" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">5</span>, <span class="dv">2</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;2022-01-20 04:05:06&#39;</span>),</span>
<span id="cb4-12"><a href="sql-questions.html#cb4-12" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">6</span>, <span class="dv">3</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;2022-01-09 04:05:06&#39;</span>),</span>
<span id="cb4-13"><a href="sql-questions.html#cb4-13" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">7</span>, <span class="dv">4</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;2022-01-09 04:05:06&#39;</span>),</span>
<span id="cb4-14"><a href="sql-questions.html#cb4-14" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">8</span>, <span class="dv">4</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;2022-01-09 04:05:06&#39;</span>),</span>
<span id="cb4-15"><a href="sql-questions.html#cb4-15" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">9</span>, <span class="dv">1</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;2022-01-20 04:05:06&#39;</span>)</span>
<span id="cb4-16"><a href="sql-questions.html#cb4-16" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb4-17"><a href="sql-questions.html#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="sql-questions.html#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="sql-questions.html#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> date_calc <span class="kw">AS</span> (</span>
<span id="cb4-20"><a href="sql-questions.html#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb4-21"><a href="sql-questions.html#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>,</span>
<span id="cb4-22"><a href="sql-questions.html#cb4-22" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">CAST</span>(encounter_end <span class="kw">AS</span> <span class="dt">date</span>) <span class="op">-</span> <span class="fu">CAST</span>(encounter_start <span class="kw">AS</span> <span class="dt">date</span>)) <span class="kw">AS</span> los</span>
<span id="cb4-23"><a href="sql-questions.html#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> encounters</span>
<span id="cb4-24"><a href="sql-questions.html#cb4-24" aria-hidden="true" tabindex="-1"></a>), grouped_diagnosis <span class="kw">AS</span> (</span>
<span id="cb4-25"><a href="sql-questions.html#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> </span>
<span id="cb4-26"><a href="sql-questions.html#cb4-26" aria-hidden="true" tabindex="-1"></a>        diagnosis_id,</span>
<span id="cb4-27"><a href="sql-questions.html#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> n</span>
<span id="cb4-28"><a href="sql-questions.html#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> date_calc</span>
<span id="cb4-29"><a href="sql-questions.html#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> los <span class="op">&gt;</span> <span class="dv">3</span></span>
<span id="cb4-30"><a href="sql-questions.html#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> </span>
<span id="cb4-31"><a href="sql-questions.html#cb4-31" aria-hidden="true" tabindex="-1"></a>        diagnosis_id</span>
<span id="cb4-32"><a href="sql-questions.html#cb4-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-33"><a href="sql-questions.html#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb4-34"><a href="sql-questions.html#cb4-34" aria-hidden="true" tabindex="-1"></a>    diagnosis_id</span>
<span id="cb4-35"><a href="sql-questions.html#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> grouped_diagnosis</span>
<span id="cb4-36"><a href="sql-questions.html#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> n <span class="kw">DESC</span></span>
<span id="cb4-37"><a href="sql-questions.html#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code></pre></div>
</div>
<div id="employee-survey-results" class="section level3 hasAnchor" number="2.2.3">
<h3><span class="header-section-number">2.2.3</span> Employee survey results<a href="sql-questions.html#employee-survey-results" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Suppose you’re consulting for a company, and you’ve sent out a survey that asks successive qustions randomly. The survey logs data into a table called survey_logging. The schema of the table is:</p>
<table>
<caption><code>survey_logging</code></caption>
<colgroup>
<col width="34%" />
<col width="28%" />
<col width="37%" />
</colgroup>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Data Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>employee_id</td>
<td>integer</td>
<td>employee id of the survey respondant</td>
</tr>
<tr class="even">
<td>action</td>
<td>string</td>
<td>Will be one of the following values, ‘view’, ‘answer’, ‘skip’</td>
</tr>
<tr class="odd">
<td>question_id</td>
<td>integer</td>
<td>ID of the question asked</td>
</tr>
<tr class="even">
<td>answer_id</td>
<td>integer</td>
<td>ID of the answer asked</td>
</tr>
<tr class="odd">
<td>timestamp</td>
<td>integer</td>
<td>time stamp of the action made by respondant</td>
</tr>
</tbody>
</table>
<p>Using SQL, find which question has the highest response rate.</p>
<p><a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=f05742ca02d15bc90aaf42676bf39894">db_fiddle</a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="sql-questions.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*Intermediate result would look like:</span></span>
<span id="cb5-2"><a href="sql-questions.html#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"> | question_id | response_rate |  */</span></span>
<span id="cb5-3"><a href="sql-questions.html#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="sql-questions.html#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> survey_logging</span>
<span id="cb5-5"><a href="sql-questions.html#cb5-5" aria-hidden="true" tabindex="-1"></a>    (user_id <span class="dt">int</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>, <span class="ot">&quot;action&quot;</span> <span class="dt">varchar</span>(<span class="dv">10</span>), question_id <span class="dt">int</span>)</span>
<span id="cb5-6"><a href="sql-questions.html#cb5-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-7"><a href="sql-questions.html#cb5-7" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb5-8"><a href="sql-questions.html#cb5-8" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb5-9"><a href="sql-questions.html#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> survey_logging</span>
<span id="cb5-10"><a href="sql-questions.html#cb5-10" aria-hidden="true" tabindex="-1"></a>    (user_id, <span class="ot">&quot;action&quot;</span>, question_id)</span>
<span id="cb5-11"><a href="sql-questions.html#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb5-12"><a href="sql-questions.html#cb5-12" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="st">&#39;answer&#39;</span>, <span class="dv">1</span>),</span>
<span id="cb5-13"><a href="sql-questions.html#cb5-13" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="st">&#39;answer&#39;</span>, <span class="dv">1</span>),</span>
<span id="cb5-14"><a href="sql-questions.html#cb5-14" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>,<span class="st">&#39;answer&#39;</span>, <span class="dv">2</span>),</span>
<span id="cb5-15"><a href="sql-questions.html#cb5-15" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span>,<span class="st">&#39;skip&#39;</span>, <span class="dv">2</span>),</span>
<span id="cb5-16"><a href="sql-questions.html#cb5-16" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">5</span>,<span class="st">&#39;skip&#39;</span>, <span class="dv">1</span>),</span>
<span id="cb5-17"><a href="sql-questions.html#cb5-17" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">6</span>,<span class="st">&#39;answer&#39;</span>, <span class="dv">1</span>),</span>
<span id="cb5-18"><a href="sql-questions.html#cb5-18" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">7</span>,<span class="st">&#39;answer&#39;</span>, <span class="dv">1</span>),</span>
<span id="cb5-19"><a href="sql-questions.html#cb5-19" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">8</span>,<span class="st">&#39;answer&#39;</span>, <span class="dv">1</span>),</span>
<span id="cb5-20"><a href="sql-questions.html#cb5-20" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">9</span>,<span class="st">&#39;skip&#39;</span>, <span class="dv">1</span>),</span>
<span id="cb5-21"><a href="sql-questions.html#cb5-21" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">10</span>,<span class="st">&#39;skip&#39;</span>, <span class="dv">2</span>)</span>
<span id="cb5-22"><a href="sql-questions.html#cb5-22" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb5-23"><a href="sql-questions.html#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co">/*~~~~~~~~~~~~~~~~~~~~~*/</span></span>
<span id="cb5-24"><a href="sql-questions.html#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="sql-questions.html#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> response_by_q <span class="kw">AS</span> (</span>
<span id="cb5-26"><a href="sql-questions.html#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> </span>
<span id="cb5-27"><a href="sql-questions.html#cb5-27" aria-hidden="true" tabindex="-1"></a>        question_id,</span>
<span id="cb5-28"><a href="sql-questions.html#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">SUM</span> (<span class="cf">CASE</span></span>
<span id="cb5-29"><a href="sql-questions.html#cb5-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">WHEN</span> action <span class="op">=</span> <span class="st">&#39;answer&#39;</span> <span class="cf">THEN</span> <span class="dv">1</span> </span>
<span id="cb5-30"><a href="sql-questions.html#cb5-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">ELSE</span> <span class="dv">0</span></span>
<span id="cb5-31"><a href="sql-questions.html#cb5-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">END</span>) <span class="kw">AS</span> answered,</span>
<span id="cb5-32"><a href="sql-questions.html#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> ovr_count</span>
<span id="cb5-33"><a href="sql-questions.html#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> survey_logging</span>
<span id="cb5-34"><a href="sql-questions.html#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> question_id</span>
<span id="cb5-35"><a href="sql-questions.html#cb5-35" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb5-36"><a href="sql-questions.html#cb5-36" aria-hidden="true" tabindex="-1"></a>extra_column <span class="kw">AS</span> (</span>
<span id="cb5-37"><a href="sql-questions.html#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> </span>
<span id="cb5-38"><a href="sql-questions.html#cb5-38" aria-hidden="true" tabindex="-1"></a>        question_id,</span>
<span id="cb5-39"><a href="sql-questions.html#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ROUND</span>(answered <span class="op">*</span> <span class="fl">100.0</span> <span class="op">/</span> ovr_count, <span class="dv">1</span>) <span class="kw">AS</span> answer</span>
<span id="cb5-40"><a href="sql-questions.html#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> response_by_q</span>
<span id="cb5-41"><a href="sql-questions.html#cb5-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-42"><a href="sql-questions.html#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> question_id</span>
<span id="cb5-43"><a href="sql-questions.html#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> extra_column</span>
<span id="cb5-44"><a href="sql-questions.html#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> answer <span class="op">=</span> (<span class="kw">SELECT</span> <span class="fu">MAX</span>(answer) <span class="kw">FROM</span> extra_column)</span></code></pre></div>
</div>
<div id="calculating-student-attendance" class="section level3 hasAnchor" number="2.2.4">
<h3><span class="header-section-number">2.2.4</span> Calculating student attendance<a href="sql-questions.html#calculating-student-attendance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Given the following table schemas, how would you figure out the overall attendance rate for each grade on 2022-01-08? Solution will be written in SQL for premium users.</p>
<p>Table 1: <code>student_attendance_log</code></p>
<table>
<colgroup>
<col width="32%" />
<col width="32%" />
<col width="35%" />
</colgroup>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Data Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>date</td>
<td>string</td>
<td>date of log per student_id, format is timestamp</td>
</tr>
<tr class="even">
<td>student_id</td>
<td>integer</td>
<td>id of the student</td>
</tr>
<tr class="odd">
<td>attendance_status</td>
<td>string</td>
<td>Possible values are [‘present’, ‘tardy’, ‘absent’]</td>
</tr>
</tbody>
</table>
<p>Table 2: <code>student_demographic</code></p>
<table>
<colgroup>
<col width="35%" />
<col width="29%" />
<col width="35%" />
</colgroup>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Data Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>student_id</td>
<td>integer</td>
<td>id of the student</td>
</tr>
<tr class="even">
<td>grade_level</td>
<td>integer</td>
<td>will be a value between 0-12, which corresponds</td>
</tr>
<tr class="odd">
<td>date_of_birth</td>
<td>string</td>
<td>Student birth date, format is ‘yyyy-mm-dd’</td>
</tr>
</tbody>
</table>
<p><a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=bf2331697519f4eb2da3c248808d39e0">db_fiddle</a></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="sql-questions.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> student_attendence_log</span>
<span id="cb6-2"><a href="sql-questions.html#cb6-2" aria-hidden="true" tabindex="-1"></a>  (student_id <span class="dt">int</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>, <span class="ot">&quot;date&quot;</span> <span class="dt">varchar</span>, attendence_status <span class="dt">varchar</span>);</span>
<span id="cb6-3"><a href="sql-questions.html#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="sql-questions.html#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> student_attendence_log</span>
<span id="cb6-5"><a href="sql-questions.html#cb6-5" aria-hidden="true" tabindex="-1"></a>  (student_id, <span class="ot">&quot;date&quot;</span>, attendence_status)</span>
<span id="cb6-6"><a href="sql-questions.html#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb6-7"><a href="sql-questions.html#cb6-7" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;present&#39;</span>),</span>
<span id="cb6-8"><a href="sql-questions.html#cb6-8" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;present&#39;</span>),</span>
<span id="cb6-9"><a href="sql-questions.html#cb6-9" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;tardy&#39;</span>),</span>
<span id="cb6-10"><a href="sql-questions.html#cb6-10" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">4</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;present&#39;</span>),</span>
<span id="cb6-11"><a href="sql-questions.html#cb6-11" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">5</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;absent&#39;</span>),</span>
<span id="cb6-12"><a href="sql-questions.html#cb6-12" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">6</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;present&#39;</span>),</span>
<span id="cb6-13"><a href="sql-questions.html#cb6-13" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">7</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;tardy&#39;</span>),</span>
<span id="cb6-14"><a href="sql-questions.html#cb6-14" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">8</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;present&#39;</span>),</span>
<span id="cb6-15"><a href="sql-questions.html#cb6-15" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">9</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;tardy&#39;</span>)</span>
<span id="cb6-16"><a href="sql-questions.html#cb6-16" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb6-17"><a href="sql-questions.html#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="sql-questions.html#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> student_demographic</span>
<span id="cb6-19"><a href="sql-questions.html#cb6-19" aria-hidden="true" tabindex="-1"></a>  (student_id <span class="dt">int</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>, grade_level <span class="dt">varchar</span>);</span>
<span id="cb6-20"><a href="sql-questions.html#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="sql-questions.html#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> student_demographic</span>
<span id="cb6-22"><a href="sql-questions.html#cb6-22" aria-hidden="true" tabindex="-1"></a>  (student_id, grade_level)</span>
<span id="cb6-23"><a href="sql-questions.html#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb6-24"><a href="sql-questions.html#cb6-24" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="st">&#39;11&#39;</span>),</span>
<span id="cb6-25"><a href="sql-questions.html#cb6-25" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="st">&#39;12&#39;</span>),</span>
<span id="cb6-26"><a href="sql-questions.html#cb6-26" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="st">&#39;12&#39;</span>),</span>
<span id="cb6-27"><a href="sql-questions.html#cb6-27" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">4</span>, <span class="st">&#39;10&#39;</span>),</span>
<span id="cb6-28"><a href="sql-questions.html#cb6-28" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">5</span>, <span class="st">&#39;11&#39;</span>),</span>
<span id="cb6-29"><a href="sql-questions.html#cb6-29" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">6</span>, <span class="st">&#39;11&#39;</span>),</span>
<span id="cb6-30"><a href="sql-questions.html#cb6-30" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">7</span>, <span class="st">&#39;12&#39;</span>),</span>
<span id="cb6-31"><a href="sql-questions.html#cb6-31" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">8</span>, <span class="st">&#39;10&#39;</span>),</span>
<span id="cb6-32"><a href="sql-questions.html#cb6-32" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">9</span>, <span class="st">&#39;10&#39;</span>)</span>
<span id="cb6-33"><a href="sql-questions.html#cb6-33" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb6-34"><a href="sql-questions.html#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="sql-questions.html#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co">-- table 1 date and attendence &#39;present&#39; and total</span></span>
<span id="cb6-36"><a href="sql-questions.html#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- aggregate on grade table 2 </span></span>
<span id="cb6-37"><a href="sql-questions.html#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="sql-questions.html#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> merged <span class="kw">AS</span> (</span>
<span id="cb6-39"><a href="sql-questions.html#cb6-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="ot">&quot;date&quot;</span>:<span class="ch">:date</span>, a.student_id, a.attendence_status, b.grade_level</span>
<span id="cb6-40"><a href="sql-questions.html#cb6-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> student_demographic b</span>
<span id="cb6-41"><a href="sql-questions.html#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> student_attendence_log a</span>
<span id="cb6-42"><a href="sql-questions.html#cb6-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> a.student_id <span class="op">=</span> b.student_id</span>
<span id="cb6-43"><a href="sql-questions.html#cb6-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="ot">&quot;date&quot;</span>:<span class="ch">:date</span> <span class="op">=</span> <span class="fu">to_date</span>(<span class="st">&#39;2022-01-08&#39;</span>,<span class="st">&#39;YYYY-MM-DD&#39;</span>)</span>
<span id="cb6-44"><a href="sql-questions.html#cb6-44" aria-hidden="true" tabindex="-1"></a>), </span>
<span id="cb6-45"><a href="sql-questions.html#cb6-45" aria-hidden="true" tabindex="-1"></a>present_vs_total <span class="kw">AS</span> (</span>
<span id="cb6-46"><a href="sql-questions.html#cb6-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> </span>
<span id="cb6-47"><a href="sql-questions.html#cb6-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SUM</span>(<span class="cf">CASE</span> </span>
<span id="cb6-48"><a href="sql-questions.html#cb6-48" aria-hidden="true" tabindex="-1"></a>      <span class="cf">WHEN</span> attendence_status <span class="op">=</span> <span class="st">&#39;present&#39;</span> </span>
<span id="cb6-49"><a href="sql-questions.html#cb6-49" aria-hidden="true" tabindex="-1"></a>      <span class="cf">THEN</span> <span class="dv">1</span> </span>
<span id="cb6-50"><a href="sql-questions.html#cb6-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">ELSE</span> <span class="dv">0</span> </span>
<span id="cb6-51"><a href="sql-questions.html#cb6-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span>) <span class="kw">AS</span> <span class="kw">present</span>,</span>
<span id="cb6-52"><a href="sql-questions.html#cb6-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total,</span>
<span id="cb6-53"><a href="sql-questions.html#cb6-53" aria-hidden="true" tabindex="-1"></a>    grade_level</span>
<span id="cb6-54"><a href="sql-questions.html#cb6-54" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> merged</span>
<span id="cb6-55"><a href="sql-questions.html#cb6-55" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> grade_level</span>
<span id="cb6-56"><a href="sql-questions.html#cb6-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-57"><a href="sql-questions.html#cb6-57" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb6-58"><a href="sql-questions.html#cb6-58" aria-hidden="true" tabindex="-1"></a>  grade_level,</span>
<span id="cb6-59"><a href="sql-questions.html#cb6-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>((<span class="kw">present</span>:<span class="ch">:float</span> <span class="op">/</span> total:<span class="ch">:float</span>):<span class="ch">:numeric</span>,<span class="dv">2</span>) <span class="kw">AS</span> attendence_rate</span>
<span id="cb6-60"><a href="sql-questions.html#cb6-60" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> present_vs_total</span></code></pre></div>
</div>
<div id="music-streaming-behavior" class="section level3 hasAnchor" number="2.2.5">
<h3><span class="header-section-number">2.2.5</span> Music streaming behavior<a href="sql-questions.html#music-streaming-behavior" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Below are two table schemas for a popular music streaming application:</p>
<p>Table 1: <code>user_song_log</code></p>
<table>
<colgroup>
<col width="35%" />
<col width="29%" />
<col width="35%" />
</colgroup>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Data Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>user_id</td>
<td>id</td>
<td>id of the streaming user</td>
</tr>
<tr class="even">
<td>timestamp</td>
<td>integer</td>
<td>timestamp of when the user started listening to the song, epoch seconds</td>
</tr>
<tr class="odd">
<td>song_id</td>
<td>integer</td>
<td>id of the song</td>
</tr>
<tr class="even">
<td>artist_id</td>
<td>integer</td>
<td>id of the artist</td>
</tr>
</tbody>
</table>
<p>Table 2: <code>song_info</code></p>
<table>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Data Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>song_id</td>
<td>integer</td>
<td>id of the song</td>
</tr>
<tr class="even">
<td>artist_id</td>
<td>integer</td>
<td>id of the artist</td>
</tr>
<tr class="odd">
<td>song_length</td>
<td>integer</td>
<td>length of song in seconds</td>
</tr>
</tbody>
</table>
<p>Question: Given the above, can you write a SQL query to estimate the average number of hours a user spends listening to music daily? You can assume that once a given user starts a song, they listen to it in its entirety.</p>
<p><a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=2a864275babe37bea33d2a7c352468af">dbfiddle</a></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb7-1"><a href="sql-questions.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> user_song_log</span>
<span id="cb7-2"><a href="sql-questions.html#cb7-2" aria-hidden="true" tabindex="-1"></a>  (user_id <span class="dt">int</span>, <span class="ot">&quot;timestamp&quot;</span> bigint, song_id <span class="dt">int</span>);</span>
<span id="cb7-3"><a href="sql-questions.html#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="sql-questions.html#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> user_song_log</span>
<span id="cb7-5"><a href="sql-questions.html#cb7-5" aria-hidden="true" tabindex="-1"></a>  (user_id, <span class="ot">&quot;timestamp&quot;</span>, song_id)</span>
<span id="cb7-6"><a href="sql-questions.html#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb7-7"><a href="sql-questions.html#cb7-7" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="dv">1655081554</span>, <span class="dv">1</span>),</span>
<span id="cb7-8"><a href="sql-questions.html#cb7-8" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="dv">1615080554</span>, <span class="dv">1</span>),</span>
<span id="cb7-9"><a href="sql-questions.html#cb7-9" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="dv">1635071554</span>, <span class="dv">2</span>),</span>
<span id="cb7-10"><a href="sql-questions.html#cb7-10" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">4</span>, <span class="dv">1655081544</span>, <span class="dv">3</span>),</span>
<span id="cb7-11"><a href="sql-questions.html#cb7-11" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="dv">1655081584</span>, <span class="dv">2</span>),</span>
<span id="cb7-12"><a href="sql-questions.html#cb7-12" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="dv">1635081554</span>, <span class="dv">4</span>),</span>
<span id="cb7-13"><a href="sql-questions.html#cb7-13" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="dv">1655081532</span>, <span class="dv">3</span>),</span>
<span id="cb7-14"><a href="sql-questions.html#cb7-14" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="dv">1625081524</span>, <span class="dv">3</span>),</span>
<span id="cb7-15"><a href="sql-questions.html#cb7-15" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="dv">1645081551</span>, <span class="dv">2</span>)</span>
<span id="cb7-16"><a href="sql-questions.html#cb7-16" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb7-17"><a href="sql-questions.html#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="sql-questions.html#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> song_info</span>
<span id="cb7-19"><a href="sql-questions.html#cb7-19" aria-hidden="true" tabindex="-1"></a>  (song_id <span class="dt">int</span>, song_length <span class="dt">int</span>);</span>
<span id="cb7-20"><a href="sql-questions.html#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="sql-questions.html#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> song_info</span>
<span id="cb7-22"><a href="sql-questions.html#cb7-22" aria-hidden="true" tabindex="-1"></a>  (song_id, song_length)</span>
<span id="cb7-23"><a href="sql-questions.html#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb7-24"><a href="sql-questions.html#cb7-24" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="dv">120</span>),</span>
<span id="cb7-25"><a href="sql-questions.html#cb7-25" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="dv">200</span>),</span>
<span id="cb7-26"><a href="sql-questions.html#cb7-26" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="dv">134</span>),</span>
<span id="cb7-27"><a href="sql-questions.html#cb7-27" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">4</span>, <span class="dv">233</span>)</span>
<span id="cb7-28"><a href="sql-questions.html#cb7-28" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb7-29"><a href="sql-questions.html#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="sql-questions.html#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co">-- hours is 60 * 60 from seconds</span></span>
<span id="cb7-31"><a href="sql-questions.html#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> song_length_by_day <span class="kw">AS</span> (</span>
<span id="cb7-32"><a href="sql-questions.html#cb7-32" aria-hidden="true" tabindex="-1"></a>   <span class="kw">SELECT</span> <span class="fu">SUM</span>(song_length) <span class="kw">AS</span> song_length_by_day</span>
<span id="cb7-33"><a href="sql-questions.html#cb7-33" aria-hidden="true" tabindex="-1"></a>   <span class="kw">FROM</span> (</span>
<span id="cb7-34"><a href="sql-questions.html#cb7-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span> a.user_id, <span class="fu">to_timestamp</span>(a.<span class="ot">&quot;timestamp&quot;</span>):<span class="ch">:date</span> <span class="kw">AS</span> <span class="dt">day</span>, a.song_id, b.song_length</span>
<span id="cb7-35"><a href="sql-questions.html#cb7-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">FROM</span> user_song_log a </span>
<span id="cb7-36"><a href="sql-questions.html#cb7-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">INNER</span> <span class="kw">JOIN</span> song_info b</span>
<span id="cb7-37"><a href="sql-questions.html#cb7-37" aria-hidden="true" tabindex="-1"></a>      <span class="kw">ON</span> a.song_id <span class="op">=</span> b.song_id) joined</span>
<span id="cb7-38"><a href="sql-questions.html#cb7-38" aria-hidden="true" tabindex="-1"></a>   <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="fu">user</span>, <span class="dt">day</span></span>
<span id="cb7-39"><a href="sql-questions.html#cb7-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-40"><a href="sql-questions.html#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb7-41"><a href="sql-questions.html#cb7-41" aria-hidden="true" tabindex="-1"></a>   <span class="fu">AVG</span>((song_length_by_day:<span class="ch">:float</span> <span class="op">/</span> <span class="dv">60</span>)<span class="op">/</span><span class="dv">60</span>) <span class="kw">AS</span> <span class="ot">&quot;Average hours spent listening to music daily&quot;</span></span>
<span id="cb7-42"><a href="sql-questions.html#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> song_length_by_day</span></code></pre></div>
</div>
<div id="a-hotel-chains-loyal-customers" class="section level3 hasAnchor" number="2.2.6">
<h3><span class="header-section-number">2.2.6</span> A hotel chain’s loyal customers<a href="sql-questions.html#a-hotel-chains-loyal-customers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Suppose you’re an analyst for a major US hotel chain which has locations all over the US. Your marketing team is planning a promotion focused around loyal customers, and they are trying to forecast how much revenue the promotion will bring in. However, they need help from you to understand how much revenue comes from “loyal” customers to plug into their model.</p>
<p>A “loyal” customer is defined as (1) having a membership with your company’s point system, (2) having &gt;=2 stays at each hotel the customer visited, (3) having stayed at 3 different locations throughout the US.</p>
<p>You have a table showing all transactions made in 2017. The schema of the table is below:</p>
<table>
<caption><code>customer_transactions</code></caption>
<colgroup>
<col width="32%" />
<col width="29%" />
<col width="38%" />
</colgroup>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Data Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>customer_id</td>
<td>id</td>
<td>id of the customer</td>
</tr>
<tr class="even">
<td>hotel_id</td>
<td>integer</td>
<td>unique id for hotel</td>
</tr>
<tr class="odd">
<td>transaction_id</td>
<td>integer</td>
<td>id of the given transaction</td>
</tr>
<tr class="even">
<td>first_night</td>
<td>string</td>
<td>first night of the stay, column format is “YYYY-mm-dd”</td>
</tr>
<tr class="odd">
<td>number_of_nights</td>
<td>integer</td>
<td># of nights the customer stayed in hotel</td>
</tr>
<tr class="even">
<td>total_spend</td>
<td>integer</td>
<td>total spend for transaction, in USD</td>
</tr>
<tr class="odd">
<td>is_member</td>
<td>boolean</td>
<td>indicates if the customer is a member of our points system</td>
</tr>
</tbody>
</table>
<p>Given this, can you write a SQL query that calculates percent of revenue loyal customers brought in 2017?</p>
<p><a href="http://sqlfiddle.com/#!15/b4553/19">sqlfiddle</a></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb8-1"><a href="sql-questions.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> customer_transactions </span>
<span id="cb8-2"><a href="sql-questions.html#cb8-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb8-3"><a href="sql-questions.html#cb8-3" aria-hidden="true" tabindex="-1"></a>    customer_id <span class="dt">int</span>,</span>
<span id="cb8-4"><a href="sql-questions.html#cb8-4" aria-hidden="true" tabindex="-1"></a>    hotel_id    <span class="dt">varchar</span>(<span class="dv">300</span>),</span>
<span id="cb8-5"><a href="sql-questions.html#cb8-5" aria-hidden="true" tabindex="-1"></a>    transaction_id  <span class="dt">varchar</span>(<span class="dv">300</span>),</span>
<span id="cb8-6"><a href="sql-questions.html#cb8-6" aria-hidden="true" tabindex="-1"></a>    first_night <span class="dt">varchar</span>(<span class="dv">300</span>),</span>
<span id="cb8-7"><a href="sql-questions.html#cb8-7" aria-hidden="true" tabindex="-1"></a>    number_of_nights    <span class="dt">varchar</span>(<span class="dv">300</span>),</span>
<span id="cb8-8"><a href="sql-questions.html#cb8-8" aria-hidden="true" tabindex="-1"></a>    total_spend <span class="dt">int</span>,</span>
<span id="cb8-9"><a href="sql-questions.html#cb8-9" aria-hidden="true" tabindex="-1"></a>    is_member   <span class="dt">boolean</span></span>
<span id="cb8-10"><a href="sql-questions.html#cb8-10" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb8-11"><a href="sql-questions.html#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="sql-questions.html#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">&#39;2&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="st">&#39;2020-01-01&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-13"><a href="sql-questions.html#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">&#39;2&#39;</span>, <span class="st">&#39;2&#39;</span>, <span class="st">&#39;2020-01-02&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-14"><a href="sql-questions.html#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">2</span>, <span class="st">&#39;4&#39;</span>, <span class="st">&#39;3&#39;</span>, <span class="st">&#39;2020-01-03&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-15"><a href="sql-questions.html#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">3</span>, <span class="st">&#39;4&#39;</span>, <span class="st">&#39;4&#39;</span>, <span class="st">&#39;2020-01-04&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-16"><a href="sql-questions.html#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">2</span>, <span class="st">&#39;5&#39;</span>, <span class="st">&#39;5&#39;</span>, <span class="st">&#39;2020-01-05&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-17"><a href="sql-questions.html#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">2</span>, <span class="st">&#39;6&#39;</span>, <span class="st">&#39;6&#39;</span>, <span class="st">&#39;2020-01-06&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-18"><a href="sql-questions.html#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">3</span>, <span class="st">&#39;7&#39;</span>, <span class="st">&#39;7&#39;</span>, <span class="st">&#39;2020-01-07&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-19"><a href="sql-questions.html#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">3</span>, <span class="st">&#39;7&#39;</span>, <span class="st">&#39;8&#39;</span>, <span class="st">&#39;2020-01-08&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-20"><a href="sql-questions.html#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">4</span>, <span class="st">&#39;2&#39;</span>, <span class="st">&#39;9&#39;</span>, <span class="st">&#39;2020-01-09&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-21"><a href="sql-questions.html#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">4</span>, <span class="st">&#39;4&#39;</span>, <span class="st">&#39;10&#39;</span>, <span class="st">&#39;2020-01-10&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-22"><a href="sql-questions.html#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">8</span>, <span class="st">&#39;4&#39;</span>, <span class="st">&#39;11&#39;</span>, <span class="st">&#39;2020-01-11&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-23"><a href="sql-questions.html#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">8</span>, <span class="st">&#39;2&#39;</span>, <span class="st">&#39;12&#39;</span>, <span class="st">&#39;2020-01-12&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-24"><a href="sql-questions.html#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">8</span>, <span class="st">&#39;7&#39;</span>, <span class="st">&#39;13&#39;</span>, <span class="st">&#39;2020-01-13&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-25"><a href="sql-questions.html#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">8</span>, <span class="st">&#39;7&#39;</span>, <span class="st">&#39;14&#39;</span>, <span class="st">&#39;2020-01-14&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-26"><a href="sql-questions.html#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">8</span>, <span class="st">&#39;4&#39;</span>, <span class="st">&#39;15&#39;</span>, <span class="st">&#39;2020-01-15&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-27"><a href="sql-questions.html#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">8</span>, <span class="st">&#39;6&#39;</span>, <span class="st">&#39;16&#39;</span>, <span class="st">&#39;2020-01-16&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-28"><a href="sql-questions.html#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">&#39;7&#39;</span>, <span class="st">&#39;17&#39;</span>, <span class="st">&#39;2020-01-17&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-29"><a href="sql-questions.html#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">&#39;7&#39;</span>, <span class="st">&#39;18&#39;</span>, <span class="st">&#39;2020-01-18&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-30"><a href="sql-questions.html#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">8</span>, <span class="st">&#39;6&#39;</span>, <span class="st">&#39;19&#39;</span>, <span class="st">&#39;2020-01-19&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">TRUE</span>);</span>
<span id="cb8-31"><a href="sql-questions.html#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">7</span>, <span class="st">&#39;4&#39;</span>, <span class="st">&#39;20&#39;</span>, <span class="st">&#39;2020-01-20&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-32"><a href="sql-questions.html#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">7</span>, <span class="st">&#39;4&#39;</span>, <span class="st">&#39;21&#39;</span>, <span class="st">&#39;2020-01-21&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-33"><a href="sql-questions.html#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">6</span>, <span class="st">&#39;2&#39;</span>, <span class="st">&#39;22&#39;</span>, <span class="st">&#39;2020-01-22&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-34"><a href="sql-questions.html#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">6</span>, <span class="st">&#39;7&#39;</span>, <span class="st">&#39;23&#39;</span>, <span class="st">&#39;2020-01-23&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-35"><a href="sql-questions.html#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">5</span>, <span class="st">&#39;7&#39;</span>, <span class="st">&#39;24&#39;</span>, <span class="st">&#39;2020-01-24&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-36"><a href="sql-questions.html#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> customer_transactions (customer_id,hotel_id,transaction_id,first_night,number_of_nights,total_spend,is_member) <span class="kw">VALUES</span> (<span class="dv">5</span>, <span class="st">&#39;4&#39;</span>, <span class="st">&#39;25&#39;</span>, <span class="st">&#39;2020-01-25&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="dv">1000</span>, <span class="kw">FALSE</span>);</span>
<span id="cb8-37"><a href="sql-questions.html#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="sql-questions.html#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co">--~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb8-39"><a href="sql-questions.html#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="sql-questions.html#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> plus_two_hotel <span class="kw">AS</span> (</span>
<span id="cb8-41"><a href="sql-questions.html#cb8-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> customer_id, hotel_id, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> two_plus_at_hotel, <span class="dv">1</span> <span class="kw">AS</span> plus_two_hotel</span>
<span id="cb8-42"><a href="sql-questions.html#cb8-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> customer_transactions</span>
<span id="cb8-43"><a href="sql-questions.html#cb8-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> customer_id, hotel_id</span>
<span id="cb8-44"><a href="sql-questions.html#cb8-44" aria-hidden="true" tabindex="-1"></a>  <span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="op">&gt;=</span> <span class="dv">2</span></span>
<span id="cb8-45"><a href="sql-questions.html#cb8-45" aria-hidden="true" tabindex="-1"></a>), three_locations <span class="kw">AS</span> (</span>
<span id="cb8-46"><a href="sql-questions.html#cb8-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> customer_id, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span>(hotel_id)) <span class="kw">AS</span> three_hotels, <span class="dv">1</span> <span class="kw">AS</span> three_locations</span>
<span id="cb8-47"><a href="sql-questions.html#cb8-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> customer_transactions</span>
<span id="cb8-48"><a href="sql-questions.html#cb8-48" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> customer_id</span>
<span id="cb8-49"><a href="sql-questions.html#cb8-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="op">&gt;</span> <span class="dv">3</span></span>
<span id="cb8-50"><a href="sql-questions.html#cb8-50" aria-hidden="true" tabindex="-1"></a>), joined <span class="kw">AS</span> (</span>
<span id="cb8-51"><a href="sql-questions.html#cb8-51" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> </span>
<span id="cb8-52"><a href="sql-questions.html#cb8-52" aria-hidden="true" tabindex="-1"></a>    a.customer_id,</span>
<span id="cb8-53"><a href="sql-questions.html#cb8-53" aria-hidden="true" tabindex="-1"></a>    total_spend,</span>
<span id="cb8-54"><a href="sql-questions.html#cb8-54" aria-hidden="true" tabindex="-1"></a>    is_member,</span>
<span id="cb8-55"><a href="sql-questions.html#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COALESCE</span>(plus_two_hotel, <span class="dv">0</span>) <span class="kw">AS</span> plus_two_hotel,</span>
<span id="cb8-56"><a href="sql-questions.html#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COALESCE</span>(three_locations, <span class="dv">0</span>) <span class="kw">AS</span> three_locations</span>
<span id="cb8-57"><a href="sql-questions.html#cb8-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> customer_transactions a</span>
<span id="cb8-58"><a href="sql-questions.html#cb8-58" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> plus_two_hotel <span class="kw">AS</span> b </span>
<span id="cb8-59"><a href="sql-questions.html#cb8-59" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> a.customer_id <span class="op">=</span> b.customer_id</span>
<span id="cb8-60"><a href="sql-questions.html#cb8-60" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> three_locations <span class="kw">AS</span> c</span>
<span id="cb8-61"><a href="sql-questions.html#cb8-61" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> a.customer_id <span class="op">=</span> c.customer_id</span>
<span id="cb8-62"><a href="sql-questions.html#cb8-62" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-63"><a href="sql-questions.html#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb8-64"><a href="sql-questions.html#cb8-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ROUND</span>(((<span class="kw">SELECT</span> <span class="fu">SUM</span>(total_spend) <span class="kw">AS</span> member_spent <span class="kw">FROM</span> joined <span class="kw">WHERE</span> plus_two_hotel <span class="op">=</span> <span class="dv">1</span> <span class="kw">AND</span> three_locations <span class="op">=</span> <span class="dv">1</span> <span class="kw">AND</span> is_member <span class="op">=</span> <span class="kw">TRUE</span>):<span class="ch">:float</span> <span class="op">/</span> </span>
<span id="cb8-65"><a href="sql-questions.html#cb8-65" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="fu">SUM</span>(total_spend) <span class="kw">AS</span> all_users_spent <span class="kw">FROM</span> joined):<span class="ch">:float</span>):<span class="ch">:numeric</span> <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="kw">AS</span> percent_revenue_of_loyal_customers_in_2007</span>
<span id="cb8-66"><a href="sql-questions.html#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="co">--67.44</span></span></code></pre></div>
</div>
<div id="user-churn-on-instagram" class="section level3 hasAnchor" number="2.2.7">
<h3><span class="header-section-number">2.2.7</span> User churn on Instagram<a href="sql-questions.html#user-churn-on-instagram" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>How would you measure user churn on Instagram? <a href="https://youtu.be/4MWOXXLxSb4">source</a></p>
<p>Assume that a user is considered churned if they haven’t displayed any active behavior (read, comment, like, post) the past 7 days. How many users have churned as of today? Use the table below to address this question:</p>
<table>
<caption><code>usage</code></caption>
<thead>
<tr class="header">
<th>timestamp</th>
<th>user_id</th>
<th>activity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>‘2022-01-08 04:05:06’</td>
<td>‘read’</td>
</tr>
<tr class="even">
<td>2</td>
<td>‘2022-01-01 04:05:06’</td>
<td>‘comment’</td>
</tr>
<tr class="odd">
<td>3</td>
<td>‘2022-01-05 04:05:06’</td>
<td>‘like’</td>
</tr>
<tr class="even">
<td>3</td>
<td>‘2022-01-05 04:05:06’</td>
<td>‘post’</td>
</tr>
<tr class="odd">
<td>1</td>
<td>‘2022-01-06 04:05:06’</td>
<td>‘read’</td>
</tr>
<tr class="even">
<td>4</td>
<td>‘2022-01-02 04:05:06’</td>
<td>‘read’</td>
</tr>
<tr class="odd">
<td>3</td>
<td>‘2022-01-03 04:05:06’</td>
<td>‘comment’</td>
</tr>
<tr class="even">
<td>2</td>
<td>‘2022-01-04 04:05:06’</td>
<td>‘sign-in’</td>
</tr>
<tr class="odd">
<td>1</td>
<td>‘2022-03-05 04:05:06’</td>
<td>‘post’</td>
</tr>
</tbody>
</table>
<p><a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=efd397fe58aac2844991d94b36ff5ed4">db_fiddle</a></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb9-1"><a href="sql-questions.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="kw">usage</span></span>
<span id="cb9-2"><a href="sql-questions.html#cb9-2" aria-hidden="true" tabindex="-1"></a>  (user_id <span class="dt">int</span>, time_stamp <span class="dt">TIMESTAMP</span>, activity_type <span class="dt">varchar</span>);</span>
<span id="cb9-3"><a href="sql-questions.html#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="sql-questions.html#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> <span class="kw">usage</span></span>
<span id="cb9-5"><a href="sql-questions.html#cb9-5" aria-hidden="true" tabindex="-1"></a>  (user_id, time_stamp, activity_type)</span>
<span id="cb9-6"><a href="sql-questions.html#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb9-7"><a href="sql-questions.html#cb9-7" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="st">&#39;2022-01-08 04:05:06&#39;</span>, <span class="st">&#39;read&#39;</span>),</span>
<span id="cb9-8"><a href="sql-questions.html#cb9-8" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="st">&#39;2022-01-01 04:05:06&#39;</span>, <span class="st">&#39;comment&#39;</span>),</span>
<span id="cb9-9"><a href="sql-questions.html#cb9-9" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="st">&#39;2022-01-05 04:05:06&#39;</span>, <span class="st">&#39;like&#39;</span>),</span>
<span id="cb9-10"><a href="sql-questions.html#cb9-10" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="st">&#39;2022-01-05 04:05:06&#39;</span>, <span class="st">&#39;post&#39;</span>),</span>
<span id="cb9-11"><a href="sql-questions.html#cb9-11" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="st">&#39;2022-01-06 04:05:06&#39;</span>, <span class="st">&#39;read&#39;</span>),</span>
<span id="cb9-12"><a href="sql-questions.html#cb9-12" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">4</span>, <span class="st">&#39;2022-01-02 04:05:06&#39;</span>, <span class="st">&#39;read&#39;</span>),</span>
<span id="cb9-13"><a href="sql-questions.html#cb9-13" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="st">&#39;2022-01-03 04:05:06&#39;</span>, <span class="st">&#39;comment&#39;</span>),</span>
<span id="cb9-14"><a href="sql-questions.html#cb9-14" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="st">&#39;2022-01-04 04:05:06&#39;</span>, <span class="st">&#39;sign-in&#39;</span>),</span>
<span id="cb9-15"><a href="sql-questions.html#cb9-15" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="st">&#39;2022-03-05 04:05:06&#39;</span>, <span class="st">&#39;post&#39;</span>)</span>
<span id="cb9-16"><a href="sql-questions.html#cb9-16" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb9-17"><a href="sql-questions.html#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="sql-questions.html#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">---------</span></span>
<span id="cb9-19"><a href="sql-questions.html#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="sql-questions.html#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="sql-questions.html#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- out of order - need a window function with ORDER BY;</span></span>
<span id="cb9-22"><a href="sql-questions.html#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> prev_time_tbl <span class="kw">AS</span> (</span>
<span id="cb9-23"><a href="sql-questions.html#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> </span>
<span id="cb9-24"><a href="sql-questions.html#cb9-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>,</span>
<span id="cb9-25"><a href="sql-questions.html#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">LEAD</span>(time_stamp) <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> user_id <span class="kw">ORDER</span> <span class="kw">BY</span> time_stamp <span class="kw">DESC</span>) <span class="kw">AS</span> prev_time</span>
<span id="cb9-26"><a href="sql-questions.html#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> <span class="kw">usage</span></span>
<span id="cb9-27"><a href="sql-questions.html#cb9-27" aria-hidden="true" tabindex="-1"></a>), churn_or_not_tbl <span class="kw">AS</span> (</span>
<span id="cb9-28"><a href="sql-questions.html#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> </span>
<span id="cb9-29"><a href="sql-questions.html#cb9-29" aria-hidden="true" tabindex="-1"></a>        user_id,</span>
<span id="cb9-30"><a href="sql-questions.html#cb9-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">CASE</span> <span class="cf">WHEN</span> </span>
<span id="cb9-31"><a href="sql-questions.html#cb9-31" aria-hidden="true" tabindex="-1"></a>            (time_stamp:<span class="ch">:date</span> <span class="op">-</span> prev_time:<span class="ch">:date</span> <span class="op">&gt;=</span> <span class="dv">7</span>)</span>
<span id="cb9-32"><a href="sql-questions.html#cb9-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">THEN</span> <span class="dv">1</span> </span>
<span id="cb9-33"><a href="sql-questions.html#cb9-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span> churn_or_not</span>
<span id="cb9-34"><a href="sql-questions.html#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> prev_time_tbl</span>
<span id="cb9-35"><a href="sql-questions.html#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> user_id, churn_or_not <span class="kw">DESC</span></span>
<span id="cb9-36"><a href="sql-questions.html#cb9-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-37"><a href="sql-questions.html#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb9-38"><a href="sql-questions.html#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SUM</span>(churn_or_not) <span class="kw">AS</span> <span class="ot">&quot;# churned in 7 days ever&quot;</span></span>
<span id="cb9-39"><a href="sql-questions.html#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> churn_or_not_tbl;</span></code></pre></div>
</div>
<div id="group-users-by-year-month-and-count-visits" class="section level3 hasAnchor" number="2.2.8">
<h3><span class="header-section-number">2.2.8</span> Group users by year-month and count visits<a href="sql-questions.html#group-users-by-year-month-and-count-visits" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>From the following table, generate a summary table with the visits by each user for each year-month for the first 4 months of 2019 (2019-01-01 - 2019-04-30).</p>
<table>
<caption><code>transaction</code></caption>
<thead>
<tr class="header">
<th>user_id</th>
<th>tstamp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>2019-01-03 20:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>2019-01-05 20:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2019-01-07 20:00</td>
</tr>
<tr class="even">
<td>2</td>
<td>2019-03-07 20:00</td>
</tr>
</tbody>
</table>
<p><a href="http://www.sqlfiddle.com/#!17/5e316/3">sql_fiddle</a></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb10-1"><a href="sql-questions.html#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="sql-questions.html#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="sql-questions.html#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="kw">transaction</span> </span>
<span id="cb10-4"><a href="sql-questions.html#cb10-4" aria-hidden="true" tabindex="-1"></a>(user_id <span class="dt">int</span>, tstamp <span class="dt">timestamp</span>);</span>
<span id="cb10-5"><a href="sql-questions.html#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="sql-questions.html#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> <span class="kw">transaction</span> </span>
<span id="cb10-7"><a href="sql-questions.html#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> </span>
<span id="cb10-8"><a href="sql-questions.html#cb10-8" aria-hidden="true" tabindex="-1"></a> (<span class="dv">1</span>,<span class="st">&#39;2019-01-03 20:00&#39;</span>),</span>
<span id="cb10-9"><a href="sql-questions.html#cb10-9" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span>,<span class="st">&#39;2019-01-05 20:00&#39;</span>),</span>
<span id="cb10-10"><a href="sql-questions.html#cb10-10" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span>,<span class="st">&#39;2019-01-07 20:00&#39;</span>),  <span class="co">-- multiple visits this month</span></span>
<span id="cb10-11"><a href="sql-questions.html#cb10-11" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span>,<span class="st">&#39;2019-02-03 20:00&#39;</span>),  <span class="co">-- next month</span></span>
<span id="cb10-12"><a href="sql-questions.html#cb10-12" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span>,<span class="st">&#39;2019-03-05 20:00&#39;</span>),  <span class="co">-- next month</span></span>
<span id="cb10-13"><a href="sql-questions.html#cb10-13" aria-hidden="true" tabindex="-1"></a>(<span class="dv">2</span>,<span class="st">&#39;2019-01-07 20:00&#39;</span>),</span>
<span id="cb10-14"><a href="sql-questions.html#cb10-14" aria-hidden="true" tabindex="-1"></a>(<span class="dv">2</span>,<span class="st">&#39;2019-03-07 20:00&#39;</span>),  <span class="co">-- not next month</span></span>
<span id="cb10-15"><a href="sql-questions.html#cb10-15" aria-hidden="true" tabindex="-1"></a>(<span class="dv">3</span>,<span class="st">&#39;2019-01-07 20:00&#39;</span>),  <span class="co">-- just once</span></span>
<span id="cb10-16"><a href="sql-questions.html#cb10-16" aria-hidden="true" tabindex="-1"></a>(<span class="dv">4</span>,<span class="st">&#39;2019-02-07 20:00&#39;</span>); <span class="co">-- just once</span></span>
<span id="cb10-17"><a href="sql-questions.html#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">-----------</span></span>
<span id="cb10-18"><a href="sql-questions.html#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="sql-questions.html#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> agged_by_month <span class="kw">AS</span> (</span>
<span id="cb10-20"><a href="sql-questions.html#cb10-20" aria-hidden="true" tabindex="-1"></a>   <span class="kw">SELECT</span> patient_id,</span>
<span id="cb10-21"><a href="sql-questions.html#cb10-21" aria-hidden="true" tabindex="-1"></a>         date_trunc(<span class="st">&#39;month&#39;</span>, tstamp) <span class="kw">AS</span> <span class="dt">month</span>,</span>
<span id="cb10-22"><a href="sql-questions.html#cb10-22" aria-hidden="true" tabindex="-1"></a>         <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">AS</span> item_transactions</span>
<span id="cb10-23"><a href="sql-questions.html#cb10-23" aria-hidden="true" tabindex="-1"></a>   <span class="kw">FROM</span>   <span class="kw">transaction</span></span>
<span id="cb10-24"><a href="sql-questions.html#cb10-24" aria-hidden="true" tabindex="-1"></a>   <span class="kw">WHERE</span>  tstamp <span class="op">&gt;=</span> <span class="st">&#39;2019-01-01&#39;</span>:<span class="ch">:date</span></span>
<span id="cb10-25"><a href="sql-questions.html#cb10-25" aria-hidden="true" tabindex="-1"></a>   <span class="kw">AND</span>    tstamp <span class="op">&lt;</span>  <span class="st">&#39;2019-05-01&#39;</span>:<span class="ch">:date</span> <span class="co">-- time range of interest.</span></span>
<span id="cb10-26"><a href="sql-questions.html#cb10-26" aria-hidden="true" tabindex="-1"></a>   <span class="kw">GROUP</span> <span class="kw">BY</span> patient_id, <span class="dv">2</span></span>
<span id="cb10-27"><a href="sql-questions.html#cb10-27" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb10-28"><a href="sql-questions.html#cb10-28" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb10-29"><a href="sql-questions.html#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">distinct</span>(patient_id) <span class="kw">AS</span> <span class="fu">user</span>,</span>
<span id="cb10-30"><a href="sql-questions.html#cb10-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">to_char</span>(<span class="dt">month</span>, <span class="st">&#39;YYYY-MM&#39;</span>) <span class="kw">AS</span> <span class="dt">month</span>,</span>
<span id="cb10-31"><a href="sql-questions.html#cb10-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(item_transactions) <span class="kw">AS</span> num_visits</span>
<span id="cb10-32"><a href="sql-questions.html#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> agged_by_month</span>
<span id="cb10-33"><a href="sql-questions.html#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span></span>
<span id="cb10-34"><a href="sql-questions.html#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span></span></code></pre></div>
</div>
<div id="weekly-retention-report-with-log-data" class="section level3 hasAnchor" number="2.2.9">
<h3><span class="header-section-number">2.2.9</span> Weekly retention report with log data<a href="sql-questions.html#weekly-retention-report-with-log-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A new feature in XYZ’s core web app has rolled out to 10% of all users. Are users coming back to the feature after trying it for the first time? Generate a weekly rention report using the feature usage log.</p>
<ul>
<li>The first row of the output sample below reads: 1000 users tried the schedule feature in the week of 2019-4-20 - 2019-4-27 for the first time, and 10% of them used it again 20 weeks later</li>
<li>n week retention = % of distinct users that came back between 7n days and 7(n-1) days after their first visit<br />
</li>
<li>Users don’t have to consistently come back every single week between Week 0 and Week n, where week 0 is when they first experienced the feature, to be considered retention for Week n</li>
</ul>
<table>
<caption><code>log_data</code></caption>
<thead>
<tr class="header">
<th>created_at</th>
<th>user_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2019-03-23</td>
<td>425</td>
</tr>
<tr class="even">
<td>2019-03-23</td>
<td>426</td>
</tr>
<tr class="odd">
<td>2019-03-24</td>
<td>425</td>
</tr>
<tr class="even">
<td>2019-03-25</td>
<td>427</td>
</tr>
</tbody>
</table>
<p>Expected output:</p>
<table>
<thead>
<tr class="header">
<th>cohort</th>
<th>retention_week</th>
<th>n_users</th>
<th>retention_r</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2019-04-21</td>
<td>20</td>
<td>1000</td>
<td>10%</td>
</tr>
<tr class="even">
<td>2019-04-21</td>
<td>21</td>
<td>1000</td>
<td>8%</td>
</tr>
<tr class="odd">
<td>2019-04-28</td>
<td>1</td>
<td>800</td>
<td>40%</td>
</tr>
</tbody>
</table>
<p>(sql_fiddle)[<a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=c13fa219d1324bdd58a6373201accbe6" class="uri">https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=c13fa219d1324bdd58a6373201accbe6</a>]</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb11-1"><a href="sql-questions.html#cb11-1" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-2"><a href="sql-questions.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> log_data</span>
<span id="cb11-3"><a href="sql-questions.html#cb11-3" aria-hidden="true" tabindex="-1"></a>    (created_at <span class="dt">timestamp</span>, user_id <span class="dt">int</span>)</span>
<span id="cb11-4"><a href="sql-questions.html#cb11-4" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb11-5"><a href="sql-questions.html#cb11-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-6"><a href="sql-questions.html#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> log_data</span>
<span id="cb11-7"><a href="sql-questions.html#cb11-7" aria-hidden="true" tabindex="-1"></a>    (created_at, user_id)</span>
<span id="cb11-8"><a href="sql-questions.html#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb11-9"><a href="sql-questions.html#cb11-9" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-04-04 12:00:00&#39;</span>, <span class="dv">425</span>),</span>
<span id="cb11-10"><a href="sql-questions.html#cb11-10" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-03-27 12:00:00&#39;</span>, <span class="dv">426</span>),</span>
<span id="cb11-11"><a href="sql-questions.html#cb11-11" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-03-25 12:00:00&#39;</span>, <span class="dv">425</span>), </span>
<span id="cb11-12"><a href="sql-questions.html#cb11-12" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-04-02 12:00:00&#39;</span>, <span class="dv">427</span>),</span>
<span id="cb11-13"><a href="sql-questions.html#cb11-13" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-04-02 12:00:00&#39;</span>, <span class="dv">425</span>),</span>
<span id="cb11-14"><a href="sql-questions.html#cb11-14" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-03-19 12:00:00&#39;</span>, <span class="dv">425</span>),</span>
<span id="cb11-15"><a href="sql-questions.html#cb11-15" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-04-11 12:00:00&#39;</span>, <span class="dv">429</span>),</span>
<span id="cb11-16"><a href="sql-questions.html#cb11-16" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-04-06 12:00:00&#39;</span>, <span class="dv">423</span>),</span>
<span id="cb11-17"><a href="sql-questions.html#cb11-17" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-04-09 12:00:00&#39;</span>, <span class="dv">421</span>),</span>
<span id="cb11-18"><a href="sql-questions.html#cb11-18" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-03-20 12:00:00&#39;</span>, <span class="dv">426</span>),</span>
<span id="cb11-19"><a href="sql-questions.html#cb11-19" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-04-13 12:00:00&#39;</span>, <span class="dv">423</span>),</span>
<span id="cb11-20"><a href="sql-questions.html#cb11-20" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;2019-04-11 12:00:00&#39;</span>, <span class="dv">421</span>)</span>
<span id="cb11-21"><a href="sql-questions.html#cb11-21" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb11-22"><a href="sql-questions.html#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="sql-questions.html#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- ~~~~~~~~~~~~~~;</span></span>
<span id="cb11-24"><a href="sql-questions.html#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="sql-questions.html#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="sql-questions.html#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co">-- STEPS:;</span></span>
<span id="cb11-27"><a href="sql-questions.html#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co">-- 1. get cohort date and the start of the week, and the start of the week for the previous week for each observation in many dataset;</span></span>
<span id="cb11-28"><a href="sql-questions.html#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co">-- 2. count the retained by seeing if the date of log is within 7 days of the last - level is cohort and the start of the first week of the action; </span></span>
<span id="cb11-29"><a href="sql-questions.html#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="co">-- 3. Get total counts for cohort to join</span></span>
<span id="cb11-30"><a href="sql-questions.html#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co">-- 4. add the retention week (pretty much done in step 2 with start of the week), joining total number of users in cohort and calculating retention </span></span>
<span id="cb11-31"><a href="sql-questions.html#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="sql-questions.html#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> first_cohort <span class="kw">AS</span> (</span>
<span id="cb11-33"><a href="sql-questions.html#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> </span>
<span id="cb11-34"><a href="sql-questions.html#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>,</span>
<span id="cb11-35"><a href="sql-questions.html#cb11-35" aria-hidden="true" tabindex="-1"></a>        date_trunc(<span class="st">&#39;week&#39;</span>, <span class="fu">FIRST_VALUE</span>(created_at) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> user_id <span class="kw">ORDER</span> <span class="kw">BY</span> created_at <span class="kw">ASC</span>)):<span class="ch">:DATE</span> <span class="kw">AS</span> cohort,</span>
<span id="cb11-36"><a href="sql-questions.html#cb11-36" aria-hidden="true" tabindex="-1"></a>        date_trunc(<span class="st">&#39;week&#39;</span>, created_at):<span class="ch">:DATE</span> <span class="kw">AS</span> dt_start_wk,</span>
<span id="cb11-37"><a href="sql-questions.html#cb11-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">COALESCE</span>(<span class="fu">LAG</span>(created_at) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> user_id <span class="kw">ORDER</span> <span class="kw">BY</span> created_at <span class="kw">ASC</span>), date_trunc(<span class="st">&#39;week&#39;</span>, <span class="fu">FIRST_VALUE</span>(created_at) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> user_id <span class="kw">ORDER</span> <span class="kw">BY</span> created_at <span class="kw">ASC</span>)):<span class="ch">:DATE</span>) <span class="kw">AS</span> prev_dt</span>
<span id="cb11-38"><a href="sql-questions.html#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> log_data</span>
<span id="cb11-39"><a href="sql-questions.html#cb11-39" aria-hidden="true" tabindex="-1"></a>), distinct_users_week <span class="kw">AS</span> (</span>
<span id="cb11-40"><a href="sql-questions.html#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> </span>
<span id="cb11-41"><a href="sql-questions.html#cb11-41" aria-hidden="true" tabindex="-1"></a>        cohort,</span>
<span id="cb11-42"><a href="sql-questions.html#cb11-42" aria-hidden="true" tabindex="-1"></a>        dt_start_wk,</span>
<span id="cb11-43"><a href="sql-questions.html#cb11-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> </span>
<span id="cb11-44"><a href="sql-questions.html#cb11-44" aria-hidden="true" tabindex="-1"></a>            (created_at:<span class="ch">:DATE</span> <span class="op">-</span> prev_dt:<span class="ch">:DATE</span>) <span class="op">&lt;</span> <span class="dv">7</span> <span class="cf">THEN</span> <span class="dv">1</span> </span>
<span id="cb11-45"><a href="sql-questions.html#cb11-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> retained</span>
<span id="cb11-46"><a href="sql-questions.html#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> first_cohort</span>
<span id="cb11-47"><a href="sql-questions.html#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> cohort, dt_start_wk</span>
<span id="cb11-48"><a href="sql-questions.html#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> cohort <span class="kw">ASC</span>, dt_start_wk <span class="kw">ASC</span></span>
<span id="cb11-49"><a href="sql-questions.html#cb11-49" aria-hidden="true" tabindex="-1"></a>), cohort_count <span class="kw">AS</span> (</span>
<span id="cb11-50"><a href="sql-questions.html#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> </span>
<span id="cb11-51"><a href="sql-questions.html#cb11-51" aria-hidden="true" tabindex="-1"></a>        cohort,</span>
<span id="cb11-52"><a href="sql-questions.html#cb11-52" aria-hidden="true" tabindex="-1"></a>        <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> n_users</span>
<span id="cb11-53"><a href="sql-questions.html#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> first_cohort</span>
<span id="cb11-54"><a href="sql-questions.html#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> cohort</span>
<span id="cb11-55"><a href="sql-questions.html#cb11-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-56"><a href="sql-questions.html#cb11-56" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb11-57"><a href="sql-questions.html#cb11-57" aria-hidden="true" tabindex="-1"></a>    duw.cohort,</span>
<span id="cb11-58"><a href="sql-questions.html#cb11-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> duw.cohort <span class="kw">ORDER</span> <span class="kw">BY</span> duw.cohort, duw.dt_start_wk) <span class="kw">AS</span> retention_week,</span>
<span id="cb11-59"><a href="sql-questions.html#cb11-59" aria-hidden="true" tabindex="-1"></a>    cc.n_users,</span>
<span id="cb11-60"><a href="sql-questions.html#cb11-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CONCAT</span>(<span class="fu">ROUND</span>(duw.retained <span class="op">*</span> <span class="fl">100.0</span> <span class="op">/</span> cc.n_users,<span class="dv">0</span>), <span class="st">&#39;%&#39;</span>) <span class="kw">AS</span> retention_r</span>
<span id="cb11-61"><a href="sql-questions.html#cb11-61" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> distinct_users_week duw</span>
<span id="cb11-62"><a href="sql-questions.html#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> cohort_count cc <span class="kw">ON</span> duw.cohort <span class="op">=</span> cc.cohort;</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="python-r-analyses.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/elreb/data_science_prep/master/02-sql.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["ds-interview-guide.pdf", "ds-interview-guide.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
